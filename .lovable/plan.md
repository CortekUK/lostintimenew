
# Fix: Duplicate SKU Error When Completing Deposit Orders

## Problem

When completing a deposit order with custom items, the system throws:
```
duplicate key value violates unique constraint "products_internal_sku_key"
```

## Root Cause (Verified)

In `useDepositOrders.ts`, product inserts include `internal_sku: ''` which:
1. **Prevents** the database trigger from firing (trigger checks `IF new.internal_sku IS NULL`)
2. Empty string is NOT NULL, so trigger never generates a unique SKU
3. Multiple products with `internal_sku: ''` violate the unique constraint

## Solution (Verified Safe)

Remove the `internal_sku` field entirely from product inserts. This follows the exact same pattern used in `useDuplicateProduct.ts`:

```typescript
// If auto_generate_sku is true, don't set internal_sku - let DB trigger handle it
```

## File Changes

**File**: `src/hooks/useDepositOrders.ts`

### Change 1: Custom Item Product Creation (Line 491)

**Before:**
```typescript
.insert({
  name: item.product_name,
  ...
  location_id: order.location_id,
  internal_sku: '', // Auto-generated by trigger  <-- REMOVE
} as any)
```

**After:**
```typescript
.insert({
  name: item.product_name,
  ...
  location_id: order.location_id,
  // Note: internal_sku omitted - DB trigger auto-generates unique SKU
} as any)
```

### Change 2: Part Exchange Product Creation (Line 577)

**Before:**
```typescript
.insert({
  name: px.product_name,
  ...
  location_id: order.location_id,
  internal_sku: '', // Will be auto-generated by trigger  <-- REMOVE
} as any)
```

**After:**
```typescript
.insert({
  name: px.product_name,
  ...
  location_id: order.location_id,
  // internal_sku omitted to allow DB trigger to generate
} as any)
```

## Why This Is Safe

1. **Follows existing pattern**: `useDuplicateProduct.ts` uses exactly this approach
2. **Trigger behavior confirmed**: `gen_internal_sku` only fires when `internal_sku IS NULL`
3. **No other code affected**: All other product queries read SKU, they don't depend on a specific format
4. **Unique SKUs guaranteed**: The trigger uses a sequence (`product_sku_seq`) ensuring uniqueness

## Expected Result

After this fix:
- Custom items get unique SKUs like `00234`, `00235`, etc.
- Part exchange items get unique SKUs automatically
- Deposit orders complete successfully without constraint violations
